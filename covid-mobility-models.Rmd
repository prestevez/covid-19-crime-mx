---
title: "Crime and Covid-19: Effects of changes in routine activities in Mexico City"
author: "Patricio R Estévez-Soto"
date: "12/07/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE, echo=FALSE}
require(tidyverse)
require(lubridate)
require(magrittr)
require(sandwich)
require(lmtest)
require(texreg)

Sys.setenv("TZ"="Europe/London")
require(fable)
require(tsibble)
require(feasts)
```



# Introduction

This study seeks to examine the effect of the Covid-19-related changes in routine activities on crime patterns in an urban area. Using data from Mexico City, I use public transit passenger numbers as a suitable proxy measure to estimate the amount of activity outside homes before and after the social distancing restrictions imposed due to the Covid-19 epidemic. Then, I examine if temporal crime patterns are associated with those of the proxy measures of routine activities.

# Data

Crime data come from Mexico City's Open Data portal and represent criminal investigations undertaken by the City's criminal prosecutor's office.

```{r import-crime-data}

carpetas <- read_csv("data/carpetas-de-investigacion-pgj-de-la-ciudad-de-mexico-2020-07-03.csv", 
                     col_types = cols(
                       ao_hechos = col_double(),
                       mes_hechos = col_character(),
                       fecha_hechos = col_character(),
                       delito = col_character(),
                       categoria_delito = col_character(),
                       fiscalia = col_character(),
                       agencia = col_character(),
                       unidad_investigacion = col_character(),
                       alcaldia_hechos = col_character(),
                       colonia_hechos = col_character(),
                       ao_inicio = col_double(),
                       mes_inicio = col_character(),
                       fecha_inicio = col_datetime(format = ""),
                       calle_hechos = col_character(),
                       calle_hechos2 = col_character(),
                       longitud = col_double(),
                       latitud = col_double(),
                       geopoint = col_character()
                     )) %>% 
  mutate(fecha_hechos_parsed = parse_date_time(fecha_hechos,
                                               # orders = c("ymd_HMS", "ymd_HM", "dmy HMS", "dmy_HM")),
                                               orders = c("%Y-%m-%d %H:%M:%S", "%Y-%m-%d %H:%M", 
                                                          "%d/%m/%Y %H:%M:%S", "%d/%m/%Y %H:%M")),
         fecha_inicio_parsed = parse_date_time(fecha_inicio,
                                               # orders = c("ymd_HMS", "ymd_HM", "dmy HMS", "dmy_HM"))
                                               orders = c("%Y-%m-%d %H:%M:%S", "%Y-%m-%d %H:%M", 
                                                          "%d/%m/%Y %H:%M:%S", "%d/%m/%Y %H:%M"))
  )


carpetas %>% 
  filter(ao_hechos > 2016) %>%
  filter(str_detect(categoria_delito, "ROBO") | str_detect(delito, "ROBO")) %>%
  mutate(fecha = date(fecha_hechos_parsed)) %>%
  count(fecha) %>%
  mutate(mes = factor(months(fecha)),
         año = factor(year(fecha))) -> daily_robos

daily_robos

covid_fecha <- ymd("2020-02-29")

```

Next we import mobility data from public transport

```{r import-mobility}

metrobus <- read_csv("data/afluencia-diaria-de-metrobus-cdmx_20200703.csv")
metro <- read_csv("data/afluencia-diaria-del-metro-cdmx_20200703.csv")
preliminar <- read_csv("data/afluencia-preliminar-en-transporte-publico_20200703.csv")

metrobus %>% summary
metro %>% summary
preliminar %>% summary


metrobus %>%
  filter(Fecha >= "2017-01-01" &
           Linea != "Linea 7") %>%
  ggplot(aes(Fecha, Afluencia, colour = Linea)) + 
  geom_point(alpha = .2) +
  geom_line(alpha = .2) +
  geom_smooth(se = FALSE)

metrobus %>%
  filter(Fecha >= "2017-01-01" &
           Linea != "Linea 7") %>%
  summary

metrobus %>%
  filter(Fecha >= "2017-01-01" &
           Linea != "Linea 7") %>%
  group_by(Fecha) %>%
  summarise(Afluencia = sum(Afluencia, na.rm = TRUE)) %>%
  mutate(fecha = Fecha, tipo = "metrobus") %>%
  select(-Fecha)-> metrobus_total

metrobus_total %>% 
  ggplot(aes(fecha, Afluencia)) + 
  geom_point(alpha = .2) +
  geom_line(alpha = .2) +
  geom_smooth(se = FALSE)


metro %>%
  group_by(Fecha, Linea) %>%
  filter(!Linea %in% c("Línea 12", "Linea 12")) %>%
  summarise(Afluencia = sum(Afluencia)) %>%
  ggplot(aes(Fecha, Afluencia, colour = Linea)) +
  geom_point(alpha = .2) +
  geom_line(alpha = .2) +
  geom_smooth(se = FALSE)

metro %>%
  filter(!Linea %in% c("Línea 12", "Linea 12")) %>%
  filter(Fecha >= "2017-01-01") %>%
  group_by(Fecha) %>%
  summarise(Afluencia = sum(Afluencia, na.rm = TRUE)) %>%
  mutate(fecha = Fecha,
         tipo = "metro") %>%
  select(-Fecha) -> metro_total

metrobus_total %>%
  bind_rows(metro_total) %>%
  ggplot(aes(fecha, Afluencia, color = tipo)) +
  geom_line(alpha = 0.2) +
  geom_smooth()

preliminar %>%
  filter(ORGANISMO == "STC") %>%
  group_by(FECHA) %>%
  summarise(Afluencia = sum(`AFLUENCIA TOTAL
(cifras preliminares)`, na.rm = TRUE)) %>%
  mutate(fecha = FECHA, tipo = "metro") %>%
  select(-FECHA) -> metro_prelim
  
metro_total %>%
  bind_rows(mutate(metro_prelim, tipo = "premlim")) %>%
  filter(fecha >= "2020-03-01") %>%
  ggplot(aes(fecha, Afluencia, color = tipo)) + 
  geom_point(alpha = 0.2) +
  geom_line(alpha = 0.2) +
  geom_smooth()


metro_total %>%
  bind_rows(filter(metro_prelim, fecha > max(.$fecha))) -> metro_total_prelim

metro_total_prelim %>%
    filter(fecha >= "2020-03-01") %>%
  ggplot(aes(fecha, Afluencia, color = tipo)) + 
  geom_point(alpha = 0.2) +
  geom_line(alpha = 0.2) +
  geom_smooth()


metrobus_total %>%
  bind_rows(metro_total_prelim) %>%
  pivot_wider(names_from = tipo, values_from = Afluencia) %>%
  mutate(pas_total = metrobus + metro) -> total_pasajeros
  
total_pasajeros %>%
  ggplot(aes(fecha, pas_total)) + 
  geom_point() + 
  geom_smooth()

total_pasajeros %>%
  summary


```


# EDA

```{r eda}


total_pasajeros %>%
  as_tsibble -> total_pasajeros_ts


daily_robos %>%
  as_tsibble() -> daily_robos_ts

total_pasajeros_ts %>% summary
daily_robos_ts %>% summary

daily_robos_mob <- daily_robos_ts %>%
  left_join(total_pasajeros_ts) %>%
  drop_na


daily_robos_mob %>%
  filter(fecha < covid_fecha) %>%
  model(TSLM(n ~ lag(n) + pas_total + trend() + fourier(K = 2, period = 7)),
        TSLM(n ~ lag(n) + log(pas_total) + trend() + fourier(K = 2, period = 7)),
        ARIMA(n ~ pas_total),
        ARIMA(n ~ log(pas_total))) -> test1

#training accuracy
test1 %>%
  accuracy

test1 %>%
  tidy %>%
  filter(term %in% c("pas_total", "log(pas_total)"))


test1 %>%
  fitted %>%
  ggplot(aes(fecha, .fitted)) +
    geom_line(data = filter(daily_robos_mob, fecha < covid_fecha),
            aes(y = n, colour = "observed"), alpha = 0.2) +
  geom_line() +
  facet_wrap(~ .model)

test1 %>%
  residuals %>%
  ggplot(aes(fecha, .resid)) +
  geom_area() + 
facet_wrap(~.model)

## Test accuracy


daily_robos_mob %>%
  filter(fecha >= covid_fecha) %>%
  forecast(test1, new_data = .) -> test1_test_fcast

test1_test_fcast %>%
  accuracy(data = daily_robos_mob)

test1_test_fcast %>%
  autoplot(alpha = 0.4) +
  geom_line(data = filter(daily_robos_mob, fecha >= covid_fecha),
            aes(y = n, colour = "observed"),) 
  
daily_robos_mob %$%
  ljung_box(pas_total)

test1 %>%
  gg_tsresiduals()


```




# Models





